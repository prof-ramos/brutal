---
import {Button} from '@eliancodes/brutal-ui'
import type {SanityPost} from '@lib/sanity'

interface Props {
  post: SanityPost;
}

const {post} = Astro.props;

const categoryData: Record<string, {label: string; icon: string}> = {
  'zodiac-signs': {label: 'Signos do Zodíaco', icon: 'i-uil-star'},
  horoscopes: {label: 'Horóscopos', icon: 'i-uil-moon'},
  compatibility: {label: 'Compatibilidade', icon: 'i-uil-heart'},
  'birth-charts': {label: 'Mapa Astral', icon: 'i-uil-chart'},
  'moon-phases': {label: 'Fases da Lua', icon: 'i-uil-moon'},
  'planetary-transits': {label: 'Trânsitos', icon: 'i-uil-arrows-h'},
  'tarot-readings': {label: 'Tarô', icon: 'i-uil-layers'},
  'crystal-healing': {label: 'Cristais', icon: 'i-uil-diamond'},
  'spiritual-guidance': {label: 'Orientação Espiritual', icon: 'i-uil-star'},
  'cosmic-humor': {label: 'Humor Cósmico', icon: 'i-uil-smile'},
  'astro-memes': {label: 'Memes Astrais', icon: 'i-uil-grin'},
  'sign-roasting': {label: 'Roast de Signos', icon: 'i-uil-fire'},
}

const difficultyLabels: Record<string, string> = {
  beginner: 'Iniciante',
  intermediate: 'Intermediário',
  advanced: 'Avançado',
}

const targetAudienceData: Record<string, {label: string; icon: string}> = {
  'astrology-beginners': {label: 'Iniciantes na Astrologia', icon: 'i-uil-seedling'},
  'zodiac-enthusiasts': {label: 'Entusiastas do Zodíaco', icon: 'i-uil-star'},
  'spiritual-seekers': {label: 'Buscadores Espirituais', icon: 'i-uil-search'},
  'cosmic-skeptics': {label: 'Céticos Cósmicos', icon: 'i-uil-question-circle'},
  'meme-lovers': {label: 'Amantes de Memes', icon: 'i-uil-grin'},
}

const formatReadingTime = (minutes?: number) => {
  if (!minutes) return ''
  return `${minutes} min de leitura`
}

const formatDate = (iso?: string) => {
  if (!iso) return ''
  return new Intl.DateTimeFormat('pt-BR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(new Date(iso))
}

const zodiacIcons: Record<string, string> = {
  aries: 'i-uil-fire',
  taurus: 'i-uil-trees',
  gemini: 'i-uil-chat',
  cancer: 'i-uil-moon',
  leo: 'i-uil-star',
  virgo: 'i-uil-flower',
  libra: 'i-uil-balance-scale',
  scorpio: 'i-uil-bug',
  sagittarius: 'i-uil-arrow',
  capricorn: 'i-uil-mountains',
  aquarius: 'i-uil-water-drop-slash',
  pisces: 'i-uil-fish',
}

const primaryCategory = post.categories?.[0]
const categorySlug = primaryCategory?.slug ?? ''
const categoryInfo = categorySlug ? categoryData[categorySlug] : undefined
const categoryLabel = categoryInfo?.label ?? primaryCategory?.title
const categoryIcon = categoryInfo?.icon ?? 'i-uil-star'
const postUrl = `/blog/${post.slug}/`
const authorName = post.author?.name ?? 'Psicóloga em Outra Dimensão'
const publishedAt = formatDate(post.publishedAt ?? post.updatedAt)
const zodiacSlug = post.zodiacSign?.slug
const zodiacIcon = zodiacSlug ? zodiacIcons[zodiacSlug] ?? 'i-uil-star' : null
---

<article class="bg-white border-4 border-black card-shadow p-6 h-full flex flex-col">
  {post.featured && (
    <div class="mb-4">
      <span class="bg-secondary border-4 border-black px-4 py-2 text-sm font-black uppercase tracking-wider brutal-pill animate-pulse flex items-center gap-2">
        <div class="i-uil-star"></div> EM DESTAQUE <div class="i-uil-star"></div>
      </span>
    </div>
  )}

  {primaryCategory && categoryLabel && (
    <div class="mb-3">
      {categorySlug ? (
        <a
          href={`/blog/category/${categorySlug}`}
          class="inline-flex items-center gap-2 bg-black text-white px-3 py-2 text-sm font-bold uppercase tracking-wider hover:bg-deep transition-colors brutal-pill"
        >
          <div class={`${categoryIcon} text-sm`}></div>
          {categoryLabel}
        </a>
      ) : (
        <span class="inline-flex items-center gap-2 bg-black text-white px-3 py-2 text-sm font-bold uppercase tracking-wider brutal-pill">
          <div class={`${categoryIcon} text-sm`}></div>
          {categoryLabel}
        </span>
      )}
    </div>
  )}

  <h2 class="text-xl md:text-2xl font-bold mb-3 line-clamp-2 heading-font flex items-start gap-2">
    {zodiacIcon && (
      <div class={`${zodiacIcon} text-2xl flex-shrink-0 text-deep`}></div>
    )}
    <a href={postUrl} class="text-black hover:text-deep transition-colors">
      {post.title}
    </a>
  </h2>

  <div class="text-sm text-gray-600 mb-4 space-y-1">
    <div class="flex items-center justify-between">
      <span>Por {authorName}</span>
      <span>{publishedAt}</span>
    </div>

    <div class="flex items-center justify-between text-xs">
      {post.readingTime && (
        <span class="bg-gray-100 px-2 py-1 border border-gray-300 flex items-center gap-1">
          <div class="i-uil-book-open text-xs"></div> {formatReadingTime(post.readingTime)}
        </span>
      )}

      <div class="flex gap-2">
        {post.difficulty && (
          <span class={`px-2 py-1 border border-black text-xs font-bold ${
            post.difficulty === 'beginner'
              ? 'bg-green-100 text-green-800'
              : post.difficulty === 'intermediate'
              ? 'bg-yellow-100 text-yellow-800'
              : 'bg-red-100 text-red-800'
          }`}>
            {difficultyLabels[post.difficulty]}
          </span>
        )}
        {post.humorLevel && (
          <span class={`px-2 py-1 border border-black text-xs font-bold flex items-center gap-1 ${
            post.humorLevel === 'subtle'
              ? 'bg-blue-100 text-blue-800'
              : post.humorLevel === 'moderate'
              ? 'bg-orange-100 text-orange-800'
              : post.humorLevel === 'savage'
              ? 'bg-red-100 text-red-800'
              : 'bg-purple-100 text-purple-800'
          }`}>
            <div class={
              post.humorLevel === 'subtle'
                ? 'i-uil-smile'
                : post.humorLevel === 'moderate'
                ? 'i-uil-grin'
                : post.humorLevel === 'savage'
                ? 'i-uil-fire'
                : 'i-uil-times-circle'
            }></div>
            {post.humorLevel === 'subtle'
              ? 'Sutil'
              : post.humorLevel === 'moderate'
              ? 'Moderado'
              : post.humorLevel === 'savage'
              ? 'Savage'
              : 'Brutal'}
          </span>
        )}
      </div>
    </div>
  </div>

  <p class="text-gray-700 mb-4 flex-grow line-clamp-3">
    {post.description}
  </p>

  <div class="mb-4">
    <ul class="flex flex-wrap gap-2">
      {post.tags?.slice(0, 4).map((tag) => (
        <li>
          <a
            href={`/blog/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`}
            class="inline-block bg-tertiary hover:bg-accent border-2 border-black px-3 py-1 text-xs font-bold text-black transition-colors brutal-pill"
          >
            #{tag}
          </a>
        </li>
      ))}
      {post.tags && post.tags.length > 4 && (
        <li class="text-xs font-bold text-deep px-2 py-1 flex items-center gap-1">
          +{post.tags.length - 4} mais <div class="i-uil-star text-xs"></div>
        </li>
      )}
    </ul>
  </div>

  {post.targetAudience && targetAudienceData[post.targetAudience] && (
    <div class="mb-4 text-sm flex items-center gap-2">
      <span class="text-gray-600">Público-alvo:</span>
      <span class="font-semibold flex items-center gap-1">
        <div class={`${targetAudienceData[post.targetAudience].icon} text-xs`}></div>
        {targetAudienceData[post.targetAudience].label}
      </span>
    </div>
  )}

  <div class="mt-auto">
    <Button href={postUrl} class="w-full">
      Ler artigo completo &rarr;
    </Button>
  </div>
</article>

<style>
  .heading-font {
    font-family: 'Impact', 'Arial Black', sans-serif;
    letter-spacing: 0.5px;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-shadow {
    box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 1);
  }
</style>
