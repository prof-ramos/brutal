---
import Layout from '@layouts/Default.astro'
import BlogList from '@components/blog/BlogList.astro'
import {Button} from '@eliancodes/brutal-ui'
import {getAllPosts, type SanityPost} from '@lib/sanity'

function tagToSlug(tag: string) {
  return tag.toLowerCase().replace(/\s+/g, '-')
}

interface PathContext {
  tag: string
  posts: SanityPost[]
  slug: string
}

export async function getStaticPaths() {
  const posts = await getAllPosts()
  const tagMap = new Map<string, PathContext>()

  posts.forEach((post) => {
    (post.tags ?? []).forEach((tag) => {
      const slug = tagToSlug(tag)
      const entry = tagMap.get(slug)
      if (entry) {
        entry.posts.push(post)
      } else {
        tagMap.set(slug, {tag, slug, posts: [post]})
      }
    })
  })

  return Array.from(tagMap.values()).map((entry) => ({
    params: {tag: entry.slug},
    props: entry,
  }))
}

const {tag, posts: tagPosts}: PathContext = Astro.props
---

<Layout
  title={`Blog: ${tag}`}
  description={`Brutal Blog | Posts marcados com ${tag}`}
  pageTitle={`Brutal Blog |Â Blogposts tagged with ${tag}`}
>
  <main class='p-6 bg-purple grid gap-4'>
    <div>
      <Button href='/blog/'>&larr; Back to blog</Button>
    </div>
    <BlogList posts={tagPosts} />
  </main>
</Layout>
