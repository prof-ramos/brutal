---
import Layout from '@layouts/Default.astro';
import { Button } from '@eliancodes/brutal-ui';
---

<Layout
  title='Mapa AstraL'
  pageTitle='Mapa AstraL | Psicóloga em Outra Dimensão'
  description='Descubra insights profundos sobre sua personalidade através do nosso formulário especializado. Uma jornada de autoconhecimento em outra dimensão.'
>
  <main class='bg-primary p-6 min-h-screen flex items-center justify-center'>
    <div class='container max-w-2xl mx-auto'>
      <div class='form_area brutal-card bg-tertiary border-8 border-black p-8 transform hover:rotate-0 transition-transform duration-300'>
        <h1 class='title heading-font text-black font-black text-3xl md:text-5xl mb-2 text-center'>
          MAPA ASTRAL
        </h1>
        <p class='body-font text-black font-semibold text-center mb-8 text-lg'>
          Descubra insights sobre sua personalidade
        </p>

        <form id="astral-form" class="space-y-6">
          <div class="form_group">
            <label class="sub_title heading-font font-black text-black text-lg mb-2 block" for="nome">NOME COMPLETO</label>
            <input placeholder="Digite seu nome completo" id="nome" name="nome" class="form_style w-full px-4 py-3 border-4 border-black font-bold text-black bg-white brutal-pill focus:outline-none focus:bg-secondary transition-colors" type="text" required />
          </div>
          <div class="form_group">
            <label class="sub_title heading-font font-black text-black text-lg mb-2 block" for="email">EMAIL</label>
            <input placeholder="Digite seu email" id="email" name="email" class="form_style w-full px-4 py-3 border-4 border-black font-bold text-black bg-white brutal-pill focus:outline-none focus:bg-secondary transition-colors" type="email" required />
          </div>
          <div class="form_group">
            <label class="sub_title heading-font font-black text-black text-lg mb-2 block" for="data_nascimento">DATA DE NASCIMENTO</label>
            <input id="data_nascimento" name="data_nascimento" class="form_style w-full px-4 py-3 border-4 border-black font-bold text-black bg-white brutal-pill focus:outline-none focus:bg-secondary transition-colors" type="date" required />
          </div>
          <div class="form_group">
            <label class="sub_title heading-font font-black text-black text-lg mb-2 block" for="hora_nascimento">HORÁRIO DE NASCIMENTO</label>
            <input placeholder="Ex: 14:30" id="hora_nascimento" name="hora_nascimento" class="form_style w-full px-4 py-3 border-4 border-black font-bold text-black bg-white brutal-pill focus:outline-none focus:bg-secondary transition-colors" type="time" required />
          </div>
          <div class="form_group">
            <label class="sub_title heading-font font-black text-black text-lg mb-2 block" for="cidade_nascimento">CIDADE DE NASCIMENTO</label>
            <input placeholder="Digite sua cidade de nascimento" id="cidade_nascimento" name="cidade_nascimento" class="form_style w-full px-4 py-3 border-4 border-black font-bold text-black bg-white brutal-pill focus:outline-none focus:bg-secondary transition-colors" type="text" required />
          </div>
          <div class="form_group">
            <label class="sub_title heading-font font-black text-black text-lg mb-2 block" for="questoes_principais">QUESTÕES PRINCIPAIS</label>
            <textarea placeholder="Descreva as questões ou aspectos da vida que gostaria de explorar..." id="questoes_principais" name="questoes_principais" rows="4" class="form_style w-full px-4 py-3 border-4 border-black font-bold text-black bg-white brutal-pill focus:outline-none focus:bg-secondary transition-colors resize-vertical" required></textarea>
          </div>
          <div class="form_group">
            <label class="sub_title heading-font font-black text-black text-lg mb-2 block" for="experiencias_passadas">EXPERIÊNCIAS RELEVANTES</label>
            <textarea placeholder="Compartilhe experiências que considera importantes para sua jornada..." id="experiencias_passadas" name="experiencias_passadas" rows="4" class="form_style w-full px-4 py-3 border-4 border-black font-bold text-black bg-white brutal-pill focus:outline-none focus:bg-secondary transition-colors resize-vertical"></textarea>
          </div>
          <div class="text-center pt-4">
            <button type="submit" id="submit-button" class="btn brutal-button bg-deep border-4 border-black text-white font-black text-xl px-8 py-4 hover:bg-accent hover:text-black transition-colors w-full md:w-auto">GERAR MAPA ASTRAL</button>
            <div id="loading-spinner" class="hidden mx-auto mt-6 w-12 h-12 border-8 border-dashed rounded-full animate-spin border-black"></div>
            <p id="form-error" class="body-font text-red-600 font-bold text-lg mt-4 hidden"></p>
            <p class="body-font text-black text-sm mt-6 opacity-80">Suas informações serão tratadas com total confidencialidade.</p>
          </div>
        </form>

        <!-- Result Containers -->
        <div id="result-container" class="hidden mt-12">
          <h2 class="title heading-font text-black font-black text-3xl mb-6 text-center">Seu Resultado</h2>
          <div id="svg-result" class="brutal-card border-4 border-black mb-8"></div>
          <div class="brutal-card bg-primary border-4 border-black p-6">
            <h3 class="heading-font text-black font-black text-xl mb-4">Análise Detalhada</h3>
            <pre id="json-result" class="body-font text-black bg-white p-4 border-2 border-black whitespace-pre-wrap break-words"></pre>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
/* Custom styles for enhanced neo-brutalist form */
.form_style:focus {
  transform: translateY(2px);
  filter: drop-shadow(2px 2px 0 rgb(0 0 0 / 1));
}

.btn:hover {
  transform: translateY(2px);
  filter: drop-shadow(3px 3px 0 rgb(0 0 0 / 1));
}

.form_area {
  filter: drop-shadow(12px 12px 0 rgb(0 0 0 / 1));
}

.form_area:hover {
  filter: drop-shadow(8px 8px 0 rgb(0 0 0 / 1));
  transform: translate(2px, 2px);
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .form_area {
    filter: drop-shadow(6px 6px 0 rgb(0 0 0 / 1));
    margin: 1rem;
  }

  .form_area:hover {
    filter: drop-shadow(4px 4px 0 rgb(0 0 0 / 1));
  }

  .title {
    font-size: 2rem;
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  .form_style,
  .btn {
    border-width: 6px;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  .form_area,
  .form_style,
  .btn {
    transition: none;
    transform: none !important;
  }

  .form_area:hover {
    transform: none !important;
  }
}
</style>

<script>
  document.addEventListener('astro:page-load', function () {
    const form = document.getElementById('astral-form');
    const submitButton = document.getElementById('submit-button');
    const loadingSpinner = document.getElementById('loading-spinner');
    const resultContainer = document.getElementById('result-container');
    const svgResult = document.getElementById('svg-result');
    const jsonResult = document.getElementById('json-result');
    const formError = document.getElementById('form-error');

    if (form) {
      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        submitButton.disabled = true;
        loadingSpinner.classList.remove('hidden');
        resultContainer.classList.add('hidden');
        formError.classList.add('hidden');
        formError.textContent = '';

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          const response = await fetch('/api/mapa-astral', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });

          const responseData = await response.json();

          if (response.ok) {
            // Safely render JSON data
            jsonResult.textContent = JSON.stringify(responseData.jsonData, null, 2);

            // Clear previous SVG and safely parse and append the new one
            svgResult.innerHTML = ''; // Clear previous content
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(responseData.svgData, 'image/svg+xml');
            const sanitizedSvg = svgDoc.documentElement;

            // Basic sanitization: remove script tags
            const scripts = sanitizedSvg.getElementsByTagName('script');
            while (scripts.length > 0) {
              scripts[0].parentNode.removeChild(scripts[0]);
            }

            svgResult.appendChild(sanitizedSvg);
            
            resultContainer.classList.remove('hidden');
            form.reset();
          } else {
            let errorMessage = 'Erro de validação. Verifique os campos.';
            if (responseData.errors) {
              const firstErrorField = Object.keys(responseData.errors)[0];
              errorMessage = responseData.errors[firstErrorField][0];
            }
            formError.textContent = errorMessage;
            formError.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Erro:', error);
          formError.textContent = 'Ocorreu um erro ao enviar o formulário. Tente novamente.';
          formError.classList.remove('hidden');
        } finally {
          submitButton.disabled = false;
          loadingSpinner.classList.add('hidden');
        }
      });
    }
  });
</script>